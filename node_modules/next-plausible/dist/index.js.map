{"version":3,"file":"index.js","sources":["../lib/combinations.ts","../index.tsx"],"sourcesContent":["export default function getCombinations<T>(elements: readonly T[]): T[][] {\n  const combinations: T[][] = []\n\n  for (let i = 0; i < elements.length; i++) {\n    combinations.push([elements[i]])\n    if (i < elements.length - 1) {\n      getCombinations(elements.slice(i + 1)).forEach((combination) => {\n        combinations.push([elements[i], ...combination])\n      })\n    }\n  }\n\n  return combinations\n}\n","import React, { ReactNode } from 'react'\nimport Head from 'next/head'\nimport { NextConfig } from 'next'\nimport getConfig from 'next/config'\nimport getCombinations from './lib/combinations'\n\ntype NextPlausibleProxyOptions = {\n  subdirectory?: string\n  scriptName?: string\n  customDomain?: string\n}\n\nconst allModifiers = [\n  'exclusions',\n  'local',\n  'manual',\n  'outbound-links',\n] as const\ntype ScriptModifier = typeof allModifiers[number]\n\nconst getScriptPath = (\n  options: NextPlausibleProxyOptions,\n  ...modifiers: (ScriptModifier | null)[]\n) => {\n  const basePath = `/js/${[\n    options.scriptName ?? 'script',\n    ...modifiers.sort().filter((modifier) => modifier !== null),\n  ].join('.')}.js`\n  if (options.subdirectory) {\n    return `/${options.subdirectory}${basePath}`\n  } else {\n    return basePath\n  }\n}\n\nconst plausibleDomain = 'https://plausible.io'\n\nconst getRemoteScriptName = (domain: string, selfHosted?: boolean) =>\n  selfHosted || domain === plausibleDomain ? 'plausible' : 'index'\n\nconst getDomain = (options: { customDomain?: string }) =>\n  options.customDomain ?? plausibleDomain\n\nconst getApiEndpoint = (options: NextPlausibleProxyOptions) =>\n  `/${options.subdirectory ?? 'proxy'}/api/event`\n\nexport function withPlausibleProxy(options: NextPlausibleProxyOptions = {}) {\n  return (nextConfig: NextConfig): NextConfig => ({\n    ...nextConfig,\n    publicRuntimeConfig: {\n      ...nextConfig.publicRuntimeConfig,\n      nextPlausibleProxyOptions: options,\n    },\n    rewrites: async () => {\n      const domain = getDomain(options)\n      const getRemoteScript = (...modifiers: (ScriptModifier | null)[]) =>\n        domain +\n        getScriptPath(\n          {\n            scriptName: getRemoteScriptName(domain, domain !== plausibleDomain),\n          },\n          ...modifiers\n        )\n      const plausibleRewrites = [\n        {\n          source: getScriptPath(options),\n          destination: getRemoteScript(),\n        },\n        ...getCombinations(allModifiers).map((modifiers) => ({\n          source: getScriptPath(options, ...modifiers),\n          destination: getRemoteScript(...modifiers),\n        })),\n        {\n          source: getApiEndpoint(options),\n          destination: `${domain}/api/event`,\n        },\n      ]\n\n      if (process.env.NEXT_PLAUSIBLE_DEBUG) {\n        console.log('plausibleRewrites = ', plausibleRewrites)\n      }\n\n      const rewrites = await nextConfig.rewrites?.()\n\n      if (!rewrites) {\n        return plausibleRewrites\n      } else if (Array.isArray(rewrites)) {\n        return rewrites.concat(plausibleRewrites)\n      } else {\n        rewrites.afterFiles = rewrites.afterFiles.concat(plausibleRewrites)\n        return rewrites\n      }\n    },\n  })\n}\n\nexport default function PlausibleProvider(props: {\n  domain: string\n  customDomain?: string\n  children: ReactNode | ReactNode[]\n  manualPageviews?: boolean\n  trackLocalhost?: boolean\n  trackOutboundLinks?: boolean\n  exclude?: string\n  selfHosted?: boolean\n  enabled?: boolean\n  integrity?: string\n  scriptProps?: React.DetailedHTMLProps<\n    React.ScriptHTMLAttributes<HTMLScriptElement>,\n    HTMLScriptElement\n  >\n}) {\n  const { enabled = process.env.NODE_ENV === 'production' } = props\n  const domain = getDomain(props)\n  const proxyOptions: NextPlausibleProxyOptions | undefined =\n    getConfig()?.publicRuntimeConfig?.nextPlausibleProxyOptions\n\n  return (\n    <>\n      <Head>\n        {enabled && (\n          <script\n            async\n            defer\n            data-api={proxyOptions ? getApiEndpoint(proxyOptions) : undefined}\n            data-domain={props.domain}\n            data-exclude={props.exclude}\n            src={\n              (proxyOptions ? '' : domain) +\n              getScriptPath(\n                {\n                  ...proxyOptions,\n                  scriptName: proxyOptions\n                    ? proxyOptions.scriptName\n                    : getRemoteScriptName(domain, props.selfHosted),\n                },\n                props.trackLocalhost ? 'local' : null,\n                props.manualPageviews ? 'manual' : null,\n                props.trackOutboundLinks ? 'outbound-links' : null,\n                props.exclude ? 'exclusions' : null\n              )\n            }\n            integrity={props.integrity}\n            crossOrigin={props.integrity ? 'anonymous' : undefined}\n            {...props.scriptProps}\n          />\n        )}\n        <script\n          dangerouslySetInnerHTML={{\n            __html: `window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }`,\n          }}\n        />\n      </Head>\n      {props.children}\n    </>\n  )\n}\n\n// https://docs.plausible.io/custom-event-goals#using-custom-props\ntype Props = Record<string, unknown> | never\ntype EventOptions<P extends Props> = {\n  props: P\n  callback?: VoidFunction\n}\ntype EventOptionsTuple<P extends Props> = P extends never\n  ? [Omit<EventOptions<P>, 'props'>?]\n  : [EventOptions<P>]\ntype Events = { [K: string]: Props }\n\nexport function usePlausible<E extends Events = any>() {\n  return function <N extends keyof E>(\n    eventName: N,\n    ...rest: EventOptionsTuple<E[N]>\n  ) {\n    return (window as any).plausible?.(eventName, rest[0])\n  }\n}\n"],"names":["getConfig","React","Head"],"mappings":"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"}